name: mcpchecker MCP Evaluation

on:
  schedule:
    - cron: '0 9 * * 1'
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      task-filter:
        description: 'Regular expression to filter tasks (optional)'
        required: false
        default: ''
      verbose:
        description: 'Enable verbose output'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name == 'issue_comment' && format('pr-{0}', github.event.issue.number) || github.ref }}
  cancel-in-progress: true

env:
  JAVA_VERSION: '21'
  MCPCHECKER_VERSION: 'v0.0.4'

defaults:
  run:
    shell: bash

jobs:
  check-trigger:
    name: Check if evaluation should run
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '/run-mcpchecker'))
    outputs:
      should-run: ${{ steps.check.outputs.should-run }}
      pr-sha: ${{ steps.check.outputs.pr-sha }}
      is-pr: ${{ steps.check.outputs.is-pr }}
    steps:
      - name: Check trigger conditions
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ "${{ github.event_name }}" == "issue_comment" ]]; then
            PERMISSION=$(gh api "repos/${{ github.repository }}/collaborators/${{ github.event.comment.user.login }}/permission" --jq '.permission')
            if [[ "$PERMISSION" == "admin" || "$PERMISSION" == "write" ]]; then
              echo "should-run=true" >> $GITHUB_OUTPUT
              echo "is-pr=true" >> $GITHUB_OUTPUT
              PR_SHA=$(gh pr view "${{ github.event.issue.number }}" --repo "${{ github.repository }}" --json headRefOid --jq '.headRefOid')
              echo "pr-sha=$PR_SHA" >> $GITHUB_OUTPUT
            else
              echo "should-run=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "should-run=true" >> $GITHUB_OUTPUT
            echo "is-pr=false" >> $GITHUB_OUTPUT
            echo "pr-sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

  run-evaluation:
    name: Run MCP Evaluation
    needs: check-trigger
    if: needs.check-trigger.outputs.should-run == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.check-trigger.outputs.pr-sha }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Build MCP server
        run: ./mvnw package -DskipTests -B

      - name: Download mcpchecker
        run: |
          curl -sL "https://github.com/mcpchecker/mcpchecker/releases/download/${{ env.MCPCHECKER_VERSION }}/mcpchecker-linux-amd64.zip" -o mcpchecker.zip
          unzip mcpchecker.zip
          mv mcpchecker-linux-amd64 mcpchecker
          chmod +x mcpchecker
          ls -la mcpchecker

      - name: Start MCP server
        run: |
          # Start server in SSE mode on port 9081
          java -jar target/quarkus-app/quarkus-run.jar &
          sleep 10
          # Verify server is running (use timeout since SSE endpoint stays open)
          curl -s --max-time 2 http://localhost:9081/q/health/ready || echo "Server may need more time to start"
        env:
          REDHAT_TOKEN: ${{ secrets.REDHAT_TOKEN }}

      - name: Run mcpchecker evaluation
        id: mcpchecker
        run: |
          TASK_FILTER="${{ github.event.inputs.task-filter }}"
          VERBOSE="${{ github.event.inputs.verbose }}"

          ARGS="check evals/openai-agent/eval.yaml --output-format json"

          if [[ -n "$TASK_FILTER" ]]; then
            ARGS="$ARGS --task-filter $TASK_FILTER"
          fi

          if [[ "$VERBOSE" == "true" ]]; then
            ARGS="$ARGS --verbose"
          fi

          echo "Running: ./mcpchecker $ARGS"
          ./mcpchecker $ARGS | tee mcpchecker-results.json || true

          # Extract results for summary
          if [[ -f mcpchecker-results.json ]]; then
            echo "## mcpchecker Results" >> $GITHUB_STEP_SUMMARY
            cat mcpchecker-results.json >> $GITHUB_STEP_SUMMARY
          fi
        env:
          MODEL_BASE_URL: ${{ secrets.MODEL_BASE_URL }}
          MODEL_KEY: ${{ secrets.MODEL_KEY }}
          JUDGE_BASE_URL: ${{ secrets.JUDGE_BASE_URL }}
          JUDGE_API_KEY: ${{ secrets.JUDGE_API_KEY }}
          JUDGE_MODEL_NAME: ${{ secrets.JUDGE_MODEL_NAME }}

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: mcpchecker-results
          path: mcpchecker-results.json
          retention-days: 30

      - name: Cleanup
        if: always()
        run: pkill -f quarkus-run.jar || true
